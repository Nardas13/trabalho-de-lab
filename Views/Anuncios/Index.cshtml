@model AutoHubProjeto.Models.FiltroAnunciosViewModel

@{
    ViewData["Title"] = "Anúncios";
}

@section Styles {
    <link rel="stylesheet" href="~/css/anuncios.css" />
}

<section class="hero">
    <div class="container">
        <h1>Explora o Nosso Stock Atual</h1>

        <!-- FORM DE FILTRO -->
        <form method="get" class="search" id="filtrosForm">

            <!-- PRIMEIRA LINHA -->
            <div class="filters-row">

                <!-- CATEGORIA -->
                <div class="pill cat">
                    <span>Categoria</span>
                    <div class="custom-select">
                        <div class="selected">@(!string.IsNullOrEmpty(Model.Categoria) ? Model.Categoria : "Todas")</div>
                        <span class="arrow">▾</span>

                        <div class="custom-options">
                            <div data-value="">Todas</div>

                            @foreach (var categoria in Model.Categorias)
                            {
                                <div data-value="@categoria">@categoria</div>
                            }
                        </div>
                    </div>

                    <input type="hidden" name="Categoria" value="@Model.Categoria" />
                </div>

                <!-- MARCA -->
                <div class="pill brand">
                    <span>Marca</span>
                    <div class="custom-select">
                        <div class="selected">@(!string.IsNullOrEmpty(Model.Marca) ? Model.Marca : "Todas")</div>
                        <span class="arrow">▾</span>

                        <div class="custom-options">
                            <div data-value="">Todas</div>

                            @foreach (var marca in Model.Marcas)
                            {
                                <div data-value="@marca">@marca</div>
                            }
                        </div>
                    </div>

                    <input type="hidden" name="Marca" value="@Model.Marca" />
                </div>

                <!-- ANO MIN -->
                <div class="pill year">
                    <span>Ano (mín.)</span>
                    <input type="number" name="AnoMin"
                           placeholder="Ex: 2015"
                           value="@(Model.AnoMin ?? null)">
                </div>

                <!-- ANO MAX -->
                <div class="pill year">
                    <span>Ano (máx.)</span>
                    <input type="number" name="AnoMax"
                           placeholder="Ex: 2024"
                           value="@(Model.AnoMax ?? null)">
                </div>

            </div>

            <!-- SEGUNDA LINHA -->
            <div class="filters-row">

                <!-- PREÇO MIN -->
                <div class="pill price">
                    <span>Preço mín.</span>
                    <input type="number"
                           name="PrecoMin"
                           placeholder="€"
                           value="@(Model.PrecoMin ?? null)">
                </div>

                <!-- PREÇO MAX -->
                <div class="pill price">
                    <span>Preço máx.</span>
                    <input type="number"
                           name="PrecoMax"
                           placeholder="€"
                           value="@(Model.PrecoMax ?? null)">
                </div>

                <!-- COMBUSTIVEL -->
                <div class="pill fuel">
                    <span>Combustível</span>
                    <div class="custom-select">
                        <div class="selected">@(!string.IsNullOrEmpty(Model.Combustivel) ? Model.Combustivel : "Todos")</div>
                        <span class="arrow">▾</span>
                        <div class="custom-options">
                            <div data-value="">Todos</div>
                            <div data-value="Gasolina">Gasolina</div>
                            <div data-value="Diesel">Diesel</div>
                            <div data-value="Híbrido">Híbrido</div>
                            <div data-value="Elétrico">Elétrico</div>
                        </div>
                    </div>

                    <input type="hidden" name="Combustivel" value="@Model.Combustivel" />
                </div>

                <!-- QUILOMETRAGEM MAX (ATÉ) -->
                <div class="pill km">
                    <span>Km máx.</span>
                    <div class="custom-select">
                        <div class="selected">
                            @(Model.KmMax.HasValue ? $"Até {Model.KmMax.Value:N0} km" : "Todos")
                        </div>
                        <span class="arrow">▾</span>

                        <div class="custom-options">
                            <div data-value="">Todos</div>
                            <div data-value="10000">Até 10.000 km</div>
                            <div data-value="25000">Até 25.000 km</div>
                            <div data-value="50000">Até 50.000 km</div>
                        </div>
                    </div>

                    <input type="hidden" name="KmMax" value="@Model.KmMax" />
                </div>

                <!-- CAIXA -->
                <div class="pill box">
                    <span>Caixa</span>
                    <div class="custom-select">
                        <div class="selected">@(!string.IsNullOrEmpty(Model.Caixa) ? Model.Caixa : "Todas")</div>
                        <span class="arrow">▾</span>

                        <div class="custom-options">
                            <div data-value="">Todas</div>
                            <div data-value="Manual">Manual</div>
                            <div data-value="Automática">Automática</div>
                        </div>
                    </div>

                    <input type="hidden" name="Caixa" value="@Model.Caixa" />
                </div>

                <!-- BOTÃO PESQUISAR -->
                <button type="submit" class="btn">Pesquisar</button>
            </div>
        </form>

        <!-- ORDENAR POR -->
        <div class="order-row">
            <div class="order-left">
                
            <span class="order-label">Ordenar por</span>

            <div class="order-card">
                <div class="custom-select order-select">
                    <div class="selected">
                        @(Model.Ordenar switch {
                            "preco-desc" => "Preço mais alto",
                            "preco-asc"  => "Preço mais baixo",
                            "ano-desc"   => "Ano mais recente",
                            "ano-asc"    => "Ano mais antigo",
                            "km-asc"     => "Menos quilómetros",
                            "km-desc"    => "Mais quilómetros",
                            _ => "Relevância"
                        })
                    </div>
                    <span class="arrow">▾</span>

                    <div class="custom-options">
                        <div data-value="relevancia">Relevância</div>
                        <div data-value="preco-desc">Preço mais alto</div>
                        <div data-value="preco-asc">Preço mais baixo</div>
                        <div data-value="ano-desc">Ano mais recente</div>
                        <div data-value="ano-asc">Ano mais antigo</div>
                        <div data-value="km-asc">Menos quilómetros</div>
                        <div data-value="km-desc">Mais quilómetros</div>
                    </div>
                </div>

                <input type="hidden" name="Ordenar" value="@Model.Ordenar" form="filtrosForm" />
            </div>

            @if (User.Identity.IsAuthenticated && Model.FiltrosGuardados?.Any() == true)
            {
                <div class="order-card">
                    <div class="custom-select filter-select">
                        <div class="selected">
                            @{
                                var ativo = Model.FiltrosGuardados?
                                    .FirstOrDefault(f => f.IdFiltro == Model.FiltroAtivoId);
                            }

                            @(ativo != null ? ativo.Nome : "Aplicar filtro guardado")
                        </div>
                        <span class="arrow">▾</span>

                        <div class="custom-options">
                            @foreach (var f in Model.FiltrosGuardados)
                            {
                                <div data-value="@f.IdFiltro">@f.Nome</div>
                            }
                        </div>
                    </div>
                </div>
            }

            @if (User.Identity.IsAuthenticated && Model.TemFiltrosAtivos)
            {
                <button id="guardarFiltroBtn" class="order-btn">
                    Guardar filtros
                </button>
            }


            </div>
        </div>

        <!-- GRID DE ANÚNCIOS -->
        <div class="grid">
            @foreach (var anuncio in Model.Resultados)
            {
                var img = anuncio.AnuncioImagems
                    .OrderBy(i => i.Ordem)
                    .FirstOrDefault()?.Url ?? "imgs/carros.jpg";

                <article class="card @(anuncio.Estado == "vendido" ? "sold" : "")">
                    <div class="img-wrapper">
                        <img src="~/@img" alt="@anuncio.Titulo" class="car-image" />

                        @if (anuncio.Estado == "vendido")
                        {
                            <div class="sold-banner">VENDIDO</div>
                        }
                    </div>


                    <div class="card-body">
                        <h3 class="card-title">@anuncio.Titulo</h3>

                        <p class="meta">€ @anuncio.Preco.ToString("N0")</p>

                        <p class="details">
                            @anuncio.IdVeiculoNavigation.Quilometragem.ToString("N0") KM |
                            @anuncio.IdVeiculoNavigation.Combustivel |
                            @anuncio.IdVeiculoNavigation.Caixa
                        </p>

                        <div class="actions">
                            <a href="/Veiculos/Detalhes/@anuncio.IdAnuncio" class="btn">Ver Detalhes</a>
                        </div>
                    </div>
                </article>
            }
        </div>
    </div>
</section>

@section Scripts {
    <script>

        function showToast(message) {
            const toast = document.createElement("div");
            toast.className = "toast";
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add("show"), 10);

            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // custom-select para filtros (categoria, marca, combustível, km, caixa)
        document.querySelectorAll(".pill .custom-select").forEach(select => {
            const selected = select.querySelector(".selected");
            const options = select.querySelectorAll(".custom-options div");
            const hiddenInput = select.parentElement.querySelector("input[type='hidden']");

            selected.addEventListener("click", () => {
                document.querySelectorAll(".custom-select")
                    .forEach(s => s !== select && s.classList.remove("active"));
                select.classList.toggle("active");
            });

            options.forEach(opt => {
                opt.addEventListener("click", () => {
                    const value = opt.dataset.value ?? "";
                    selected.textContent = opt.textContent;

                    if (hiddenInput) {
                        hiddenInput.value = value;
                    }

                    select.classList.remove("active");
                });
            });
        });

        // custom-select específico para ORDENAR POR
        const orderSelect = document.querySelector(".order-select");
        if (orderSelect) {
            const selected = orderSelect.querySelector(".selected");
            const options = orderSelect.querySelectorAll(".custom-options div");
            const ordenarInput = document.querySelector("input[name='Ordenar']");

            selected.addEventListener("click", () => {
                document.querySelectorAll(".custom-select")
                    .forEach(s => s !== orderSelect && s.classList.remove("active"));
                orderSelect.classList.toggle("active");
            });

            options.forEach(opt => {
                opt.addEventListener("click", () => {
                    const value = opt.dataset.value ?? "";
                    selected.textContent = opt.textContent;

                    if (ordenarInput) {
                        ordenarInput.value = value;
                    }

                    orderSelect.classList.remove("active");

                    // submeter logo após escolher a ordenação
                    document.getElementById("filtrosForm").submit();
                });
            });
        }

        // fechar todos os dropdowns ao clicar fora
        window.addEventListener("click", e => {
            if (!e.target.closest(".custom-select")) {
                document.querySelectorAll(".custom-select").forEach(s => s.classList.remove("active"));
            }
        });

        // Guardar filtro atual
        document.getElementById("guardarFiltroBtn")?.addEventListener("click", () => {
            const params = Object.fromEntries(new URLSearchParams(window.location.search));

            if (Object.keys(params).length === 0) {
                showToast("Aplica pelo menos um filtro antes de guardar.");
                return;
            }

            fetch("/FiltrosFavoritos/Guardar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    filtros: params
                })
            })
            .then(r => r.json())
            .then(d => {
                if (!d.ok) {
                    showToast(d.msg ?? "Erro ao guardar filtro.");
                    return;
                }
                location.reload();
            });
        });

        // custom-select para aplicar filtro guardado
        document.querySelectorAll(".filter-select").forEach(select => {
            const selected = select.querySelector(".selected");
            const options = select.querySelectorAll(".custom-options div");

            selected.addEventListener("click", () => {
                document.querySelectorAll(".custom-select")
                    .forEach(s => s !== select && s.classList.remove("active"));
                select.classList.toggle("active");
            });

            options.forEach(opt => {
                opt.addEventListener("click", () => {
                    const id = opt.dataset.value;
                    const nome = opt.textContent;

                    selected.textContent = nome;

                    select.classList.remove("active");

                    setTimeout(() => {
                        window.location.href = "/FiltrosFavoritos/Aplicar?id=" + id;
                    }, 150);
                });
            });
        });


        function obterFiltrosAtivos() {
            const filtros = {};

            document.querySelectorAll("#filtrosForm input, #filtrosForm select").forEach(el => {
                if (!el.name) return;

                const val = el.value?.trim();

                if (
                    val &&
                    val !== "Todas" &&
                    val !== "Todos"
                ) {
                    filtros[el.name] = val;
                }
            });

            return filtros;
        }

        function atualizarBotaoGuardarFiltro() {
            const btn = document.getElementById("guardarFiltroBtn");
            if (!btn) return;

            const filtros = obterFiltrosAtivos();
            btn.style.display = Object.keys(filtros).length > 0 ? "inline-flex" : "none";
        }

        // ao carregar a página
        atualizarBotaoGuardarFiltro();

        // sempre que algo muda nos filtros
        document.getElementById("filtrosForm")
            ?.addEventListener("change", atualizarBotaoGuardarFiltro);

    </script>
}
