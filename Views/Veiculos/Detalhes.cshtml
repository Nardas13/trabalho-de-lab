@model AutoHubProjeto.Models.Anuncio

@{
    ViewData["Title"] = "Detalhes do Anúncio";

    var textoVendedor = Model.IdVendedorNavigation == null
        ? "Vendedor não definido"
        : (Model.IdVendedorNavigation.Tipo == "empresa"
            ? "Stand / Profissional"
            : "Vendedor particular");

    var imagensOrdenadas = Model.AnuncioImagems
        .OrderBy(i => i.Ordem)
        .ToList();

    var urlImagemPrincipal = imagensOrdenadas.Any()
        ? Url.Content("~/" + imagensOrdenadas.First().Url)
        : Url.Content("~/imgs/carros.jpg");
}

@section Styles {
    <link rel="stylesheet" href="~/css/detalhes.css" />
}

<main class="page">
    <div class="container">
        <!-- BREADCRUMB -->
        <div class="breadcrumb">
            <a href="/Anuncios/Index">Anúncios</a> ›
            <span>@Model.Titulo</span>
        </div>

        <div class="details-grid">
            <!-- GALERIA -->
            <section class="soft-card gallery">
                <img id="mainPhoto"
                     class="main-photo"
                     src="@urlImagemPrincipal"
                     alt="Foto principal do veículo">

                <div class="thumbs" id="thumbs">
                    @foreach (var img in imagensOrdenadas)
                    {
                        var url = Url.Content("~/" + img.Url);
                        var isActive = img == imagensOrdenadas.First();

                        <img class="@(isActive ? "active" : "")"
                             src="@url"
                             data-photo="@url"
                             alt="Foto @img.Ordem" />
                    }
                </div>
            </section>

            <!-- PAINEL INFO -->
            <aside class="soft-card info">
                <div class="title-row">
                    <h1>@Model.Titulo</h1>

                    <button class="fav @(Model.IsFavorito ? "active" : "") @(User.Identity.IsAuthenticated ? "" : "disabled")"
                            id="favBtn"
                            data-id="@Model.IdAnuncio"
                            data-auth="@User.Identity.IsAuthenticated.ToString().ToLower()">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 21s-6.716-4.297-9.428-7.01A5.988 5.988 0 0 1 12 5a5.988 5.988 0 0 1 9.428 8.99C18.716 16.703 12 21 12 21z" />
                        </svg>
                    </button>
                </div>

                <div class="price">
                    € @Model.Preco.ToString("N0")
                </div>

                <!-- estado do veiculo -->
                <div class="estado-badge @Model.Estado">
                    @(
                        Model.Estado switch {
                            "ativo"     => "Disponível",
                            "reservado" => "Reservado",
                            "vendido"   => "Vendido",
                            "pausado"   => "Anúncio Pausado",
                            _           => "Indefinido"
                        }
                    )
                </div>

                <div class="cta-row">
                    @if (Model.Estado == "vendido")
                    {
                        <div class="info-msg error">Este veículo já foi vendido.</div>
                    }
                    else if (Model.Estado == "pausado")
                    {
                        <div class="info-msg warn">Este anúncio está temporariamente pausado.</div>
                    }
                    else if (Model.IdVendedorNavigation?.IdVendedor == ViewBag.UserVendedorId)
                    {
                        <div class="info-msg warn">Não podes efetuar ações sobre o teu próprio veículo.</div>
                    }
                    else if (Model.Estado == "reservado")
                    {
                        <div class="info-msg warn">Este veículo está reservado. Agendamentos indisponíveis.</div>
                    }
                    else
                    {
                        <button class="btn requires-auth"
                                data-action="visita"
                                data-auth="@User.Identity.IsAuthenticated.ToString().ToLower()">Agendar Visita</button>

                        <button class="btn btn-outline requires-auth" 
                            data-action="reserva" 
                            data-auth="@User.Identity.IsAuthenticated.ToString().ToLower()"> Reservar </button>

                        <button class="btn btn-outline requires-auth"
                            data-action="comprar"
                            data-auth="@User.Identity.IsAuthenticated.ToString().ToLower()"> Comprar </button>
                    }
                </div>

                <div class="seller">
                    👤 @textoVendedor
                </div>

                <div class="soft-card overview">
                    <h3>Especificações</h3>
                    <table class="ov-table">
                        <tr>
                            <td class="ov-left">Ano</td>
                            <td class="ov-right">@Model.IdVeiculoNavigation.Ano</td>
                        </tr>
                        <tr>
                            <td class="ov-left">Marca / Modelo</td>
                            <td class="ov-right">
                                @Model.IdVeiculoNavigation.Marca @Model.IdVeiculoNavigation.Modelo
                            </td>
                        </tr>
                        <tr>
                            <td class="ov-left">Quilometragem</td>
                            <td class="ov-right">
                                @Model.IdVeiculoNavigation.Quilometragem.ToString("N0") km
                            </td>
                        </tr>
                        <tr>
                            <td class="ov-left">Caixa</td>
                            <td class="ov-right">@Model.IdVeiculoNavigation.Caixa</td>
                        </tr>
                        <tr>
                            <td class="ov-left">Combustível</td>
                            <td class="ov-right">@Model.IdVeiculoNavigation.Combustivel</td>
                        </tr>
                        <tr>
                            <td class="ov-left">Localização</td>
                            <td class="ov-right">@Model.IdVeiculoNavigation.Localizacao</td>
                        </tr>
                    </table>
                </div>
            </aside>
        </div>

        <!-- DESCRIÇÃO E EXTRAS -->
        <div class="below">
            <section class="soft-card card-pad">
                <h3>Descrição</h3>
                <p style="color:var(--txt-700);margin-top:8px">
                    @Model.IdVeiculoNavigation.Descricao
                </p>
            </section>

            <aside class="soft-card card-pad">
                <h3>Extras & Destaques</h3>
                <ul class="features" style="margin-top:8px">
                    <li>Ar condicionado automático</li>
                    <li>Bluetooth</li>
                    <li>Bancos em pele</li>
                    <li>Sistema de navegação</li>
                    <li>Computador de bordo</li>
                    <li>Direção assistida</li>
                </ul>
            </aside>
        </div>

                <!-- MODAL AGENDA VISITA -->
                <div id="modalAgendar" class="modal hidden">
                    <div class="modal-content">

                        <h2>Agendar Visita</h2>

                        <!-- Campo Data -->
                        <div class="form-field">
                            <label for="dataVisita">Data:</label>

                            <div class="input-with-icon">
                                <input id="dataVisita"
                                       type="text"
                                       placeholder="dd/mm/aaaa"
                                       autocomplete="off" />

                                <svg id="calendarIcon" viewBox="0 0 24 24">
                                    <path d="M3 8h18M8 2v4m8-4v4M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z"/>
                                </svg>

                                <div id="calendarPopup" class="calendar-popup hidden"></div>
                            </div>
                        </div>
                        <!-- Campo Hora -->
                        <div class="form-field">
                            <label for="horaVisita">Hora:</label>

                            <div class="input-with-icon">
                                <input id="horaVisita"
                                       type="text"
                                       placeholder="hh:mm"
                                       autocomplete="off" />

                                <svg id="timeIconModal" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <path d="M12 6v6l4 2"></path>
                                </svg>
                            </div>

                            <div id="listaHoras" class="time-options hidden"></div>
                        </div>

                        <div class="modal-buttons">
                            <button class="btn-outline" id="cancelarModal">Cancelar</button>
                            <button class="btn" id="confirmarVisita">Confirmar</button>
                        </div>

                    </div>
                </div>

                <!-- MODAL RESERVAR VEÍCULO -->
                <div id="modalReservar" class="modal hidden">
                    <div class="modal-content">

                        <h2>Reservar Veículo</h2>

                        <p style="font-size:14px;color:var(--txt-700);margin-bottom:14px">
                            Esta reserva garante prioridade sobre o veículo durante um período limitado.
                        </p>
                        <div class="form-field">
                            <div class="pill">
                                <span>Duração</span>

                                <div class="custom-select compact" id="selectDuracao">
                                    <div class="selected" data-value="48">48 horas</div>
                                    <span class="arrow">▾</span>

                                    <div class="custom-options">
                                        <div data-value="24">24 horas</div>
                                        <div data-value="48">48 horas</div>
                                        <div data-value="72">72 horas</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- aviso -->
                        <!---<div class="error-msg" style="background:#fffbeb;color:#92400e">
                            Durante este período, outros utilizadores não poderão comprar este veículo.
                        </div>-->

                        <div class="modal-buttons">
                            <button class="btn-outline" id="cancelarReserva">Cancelar</button>
                            <button class="btn" id="confirmarReserva">Confirmar Reserva</button>
                        </div>

                    </div>
                </div>

                <!-- MODAL COMPRAR VEÍCULO -->
                <div id="modalComprar" class="modal hidden">
                    <div class="modal-content">

                        <h2>Comprar Veículo</h2>

                        <!-- MÉTODO DE PAGAMENTO -->
                        <div class="form-field">
                            <label>Método de pagamento</label>

                            <div class="pill-group" id="metodoPagamento">
                                <button class="pill-option active" data-metodo="cartao">
                                    Cartão
                                </button>
                                <button class="pill-option" data-metodo="transferencia">
                                    Transferência
                                </button>
                                <button class="pill-option" data-metodo="stand">
                                    No stand
                                </button>
                            </div>
                        </div>

                        <!-- CONTACTO -->
                        <div class="form-field">
                            <label>Contacto associado à compra</label>

                            <p style="font-size:11px;color:var(--txt-700);margin-bottom:8px">
                                O vendedor irá utilizar estes dados para entrar em contacto contigo após a confirmação da compra.
                            </p>

                            <div class="soft-card" style="padding:12px">
                                <div style="font-size:14px">
                                    <strong>Email:</strong> @ViewBag.UserEmail
                                </div>
                                <div style="font-size:14px;color:var(--txt-700)">
                                    <strong>Telefone:</strong> @(ViewBag.UserTelefone ?? "—")
                                </div>
                            </div>
                        </div>

                        <div class="modal-buttons">
                            <button class="btn-outline" id="cancelarCompra">Cancelar</button>
                            <button class="btn" id="confirmarCompra">Confirmar Pedido de Compra</button>
                        </div>

                    </div>
                </div>

            </div>
</main>

@section Scripts {
<script>
/* ============================================================
   TOAST
============================================================ */
function showToast(msg) {
    const box = document.createElement("div");
    box.className = "toast-auth";
    box.innerText = msg;
    document.body.appendChild(box);

    setTimeout(() => box.classList.add("show"), 10);
    setTimeout(() => box.classList.remove("show"), 2200);
    setTimeout(() => box.remove(), 2700);
}

/* ============================================================
   GALERIA
============================================================ */
const main = document.getElementById("mainPhoto");
if (main) {
    const thumbs = document.querySelectorAll("#thumbs img");
    thumbs.forEach(el => {
        el.addEventListener("click", () => {
            thumbs.forEach(t => t.classList.remove("active"));
            el.classList.add("active");
            main.src = el.dataset.photo;
        });
    });
}

/* ============================================================
   FAVORITOS
============================================================ */
const fav = document.getElementById("favBtn");
if (fav) {
    fav.addEventListener("click", function () {
        const isAuth = this.dataset.auth === "true";
        if (!isAuth) return showToast("Precisas de iniciar sessão.");

        fetch("/Favoritos/Toggle?idAnuncio=" + this.dataset.id, { method: "POST" })
            .then(r => r.json())
            .then(data => {
                if (!data.ok) return showToast("Ocorreu um erro.");

                this.classList.toggle("active");
                this.style.transform = "scale(1.2)";
                setTimeout(() => this.style.transform = "scale(1)", 150);
            });
    });
}

/* ============================================================
   BLOQUEAR BOTÕES NÃO AUTENTICADOS
============================================================ */
document.querySelectorAll(".requires-auth").forEach(btn => {
    btn.addEventListener("click", function (e) {
        if (this.dataset.auth !== "true") {
            e.preventDefault();
            showToast("Inicia sessão para usar esta funcionalidade.");
        }
    });
});

/* ============================================================
   MODAIS — RESERVAR / COMPRAR
============================================================ */

// elementos dos modais
const modalReservar = document.getElementById("modalReservar");
const modalComprar  = document.getElementById("modalComprar");

// botões
const btnReserva = document.querySelector("[data-action='reserva']");
const btnComprar = document.querySelector("[data-action='comprar']");

/* ======================
   ABRIR MODAL RESERVA
====================== */
if (btnReserva && modalReservar) {
    btnReserva.addEventListener("click", function () {

        if (this.dataset.auth !== "true") {
            return showToast("Inicia sessão para usar esta funcionalidade.");
        }

        modalReservar.classList.remove("hidden");
    });
}

/* ======================
   ABRIR MODAL COMPRA
====================== */
if (btnComprar && modalComprar) {
    btnComprar.addEventListener("click", function () {

        if (this.dataset.auth !== "true") {
            return showToast("Inicia sessão para usar esta funcionalidade.");
        }

        modalComprar.classList.remove("hidden");
    });
}

/* ======================
   CANCELAR / FECHAR
====================== */
document.getElementById("cancelarReserva")
    ?.addEventListener("click", () => modalReservar.classList.add("hidden"));

document.getElementById("cancelarCompra")
    ?.addEventListener("click", () => modalComprar.classList.add("hidden"));

/* ======================
   FECHAR AO CLICAR FORA
====================== */
modalReservar?.addEventListener("click", e => {
    if (e.target === modalReservar) modalReservar.classList.add("hidden");
});

modalComprar?.addEventListener("click", e => {
    if (e.target === modalComprar) modalComprar.classList.add("hidden");
});

document.querySelectorAll(".pill-group").forEach(group => {
    group.querySelectorAll(".pill-option").forEach(btn => {
        btn.addEventListener("click", () => {
            group.querySelectorAll(".pill-option")
                .forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        });
    });
});


/* ============================================================
   MODAL – AGENDAR VISITA
============================================================ */
const modal      = document.getElementById("modalAgendar");
const dateInput  = document.getElementById("dataVisita");
const timeInput  = document.getElementById("horaVisita");
const listaHoras = document.getElementById("listaHoras");

const btnVisita = document.querySelector("[data-action='visita']");

if (btnVisita) {
    btnVisita.addEventListener("click", function () {

        if (this.dataset.auth !== "true") {
            return showToast("Inicia sessão para usar esta funcionalidade.");
        }

        modal.classList.remove("hidden");

        if (!dateInput.dataset.initialized) {
            new Datepicker(dateInput, { autohide: true, format: "dd/mm/yyyy" });
            dateInput.dataset.initialized = "true";
        }

        if (dateInput.value) carregarHorasOcupadas();
    });
}

document.getElementById("cancelarModal")
    ?.addEventListener("click", () => modal.classList.add("hidden"));

modal.addEventListener("click", e => {
    if (e.target === modal) modal.classList.add("hidden");
});


/* ============================================================
   INPUT MASK
============================================================ */
dateInput.addEventListener("input", e => {
    let v = e.target.value.replace(/\D/g, "").slice(0, 8);
    if (v.length >= 5) v = v.replace(/(\d{2})(\d{2})(\d+)/, "$1/$2/$3");
    else if (v.length >= 3) v = v.replace(/(\d{2})(\d+)/, "$1/$2");
    e.target.value = v;
});

dateInput.addEventListener("keypress", e => {
    if (!/[0-9]/.test(e.key)) e.preventDefault();
});

timeInput.readOnly = true;

/* ============================================================
   LISTA DE HORÁRIOS (Manhã / Tarde)
============================================================ */

const horarios = {
    "Manhã": ["09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00"],
    "Tarde": ["14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00"]
};

// construir visual de horários
(function buildHorarios() {
    listaHoras.innerHTML = "";
    const wrap = document.createElement("div");
    wrap.className = "time-columns";

    for (const periodo in horarios) {

        const col = document.createElement("div");
        col.innerHTML = `<div class="time-section-title">${periodo}</div>`;

        const grid = document.createElement("div");
        grid.className = "time-group";

        horarios[periodo].forEach(h => {
            const btn = document.createElement("button");
            btn.className = "time-option";
            btn.textContent = h;

            btn.addEventListener("click", () => {
                if (btn.disabled) return;
                timeInput.value = h;

                document.querySelectorAll(".time-option")
                    .forEach(o => o.classList.remove("active"));
                
                btn.classList.add("active");
                listaHoras.classList.add("hidden");
            });

            grid.appendChild(btn);
        });

        col.appendChild(grid);
        wrap.appendChild(col);
    }

    listaHoras.appendChild(wrap);
})();

/* ============================================================
   HORAS OCUPADAS
============================================================ */
dateInput.addEventListener("change", carregarHorasOcupadas);

function carregarHorasOcupadas() {
    // quando muda de data -> limpar hora escolhida
    timeInput.value = "";
    document.querySelectorAll(".time-option").forEach(btn => btn.classList.remove("active"));

    const data = dateInput.value;
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(data)) return;

    const iso = toIsoFromPt(data);

    fetch(`/Visitas/HorasOcupadas?idAnuncio=@Model.IdAnuncio&data=${iso}`)
        .then(r => r.json())
        .then(horas => marcarHorasOcupadas(horas));
}

function marcarHorasOcupadas(ocupadas) {

    // limpar 
    document.querySelectorAll(".time-option").forEach(btn => {
        btn.classList.remove("disabled");
        btn.disabled = false;
    });

    // descobrir dia da semana da data selecionada
    const data = dateInput.value;
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(data)) return;

    const iso = toIsoFromPt(data);
    const diaSemana = new Date(iso).getDay(); 
    // 0 = Domingo | 6 = Sábado

    // regras fixas de horário
    document.querySelectorAll(".time-option").forEach(btn => {
        const hora = btn.textContent.trim();

        //  DOMINGO → tudo bloqueado
        if (diaSemana === 0) {
            btn.classList.add("disabled");
            btn.disabled = true;
        }

        // SÁBADO → só 10:00–14:00
        if (diaSemana === 6) {
            if (
                hora === "09:00" ||
                hora === "09:30" ||
                hora > "14:00"
            ) {
                btn.classList.add("disabled");
                btn.disabled = true;
            }
        }

        // SEG–SEX 
    });

    //bloquear horas já ocupadas
    ocupadas.forEach(hora => {
        const btn = [...document.querySelectorAll(".time-option")]
            .find(b => b.textContent.trim() === hora.trim());

        if (btn) {
            btn.classList.add("disabled");
            btn.disabled = true;
        }
    });
}

/* abrir popup horas */
document.getElementById("timeIconModal")?.addEventListener("click", e => {
    e.stopPropagation();

    if (!dateInput.value)
        return showToast("Seleciona primeiro uma data.");

    carregarHorasOcupadas(); 
    listaHoras.classList.toggle("hidden");
});

document.addEventListener("click", e => {
    if (!listaHoras.contains(e.target) && !timeIconModal.contains(e.target)) {
        listaHoras.classList.add("hidden");
    }
});

/* ============================================================
   PARSE DATA / FUTURO
============================================================ */
function toIsoFromPt(dateStr) {
    const m = dateStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    return m ? `${m[3]}-${m[2]}-${m[1]}` : null;
}

function isPast(dateStr, timeStr) {
    const iso = toIsoFromPt(dateStr);
    const dt  = new Date(`${iso}T${timeStr}:00`);
    return dt <= new Date();
}

/* ============================================================
   SUBMIT — AGENDAR VISITA
============================================================ */
document.getElementById("confirmarVisita")
    .addEventListener("click", function () {

        const date = dateInput.value;
        const time = timeInput.value;

        if (!date || !time) return showToast("Seleciona data e hora.");
        if (isPast(date, time)) return showToast("A data/hora deve ser futura.");

        fetch("/Visitas/Agendar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                idAnuncio: @Model.IdAnuncio,
                data: toIsoFromPt(date),
                hora: time
            })
        })
        .then(r => r.json())
        .then(data => {
            showToast(data.msg);
            if (data.ok) setTimeout(() => location.reload(), 1200);
        });
    });

/* ============================================================
   CALENDÁRIO 
============================================================ */
const calIcon = document.getElementById("calendarIcon");
const calPopup = document.getElementById("calendarPopup");
const dateInput2 = dateInput;

let currentMonth = new Date().getMonth();
let currentYear  = new Date().getFullYear();

calIcon.addEventListener("click", (e) => {
    e.stopPropagation();
    calPopup.classList.toggle("hidden");
    buildCalendar(currentMonth, currentYear);
});

document.addEventListener("click", (e) => {
    if (e.target.closest(".cal-nav")) return;
    if (calPopup.contains(e.target)) return;
    if (e.target !== calIcon) calPopup.classList.add("hidden");
});

function buildCalendar(month, year) {
    calPopup.innerHTML = "";

    const today = new Date();

    const header = document.createElement("div");
    header.className = "calendar-header";
    header.innerHTML = `
        <div class="cal-nav" id="prevMonth">◀</div>
        <h4>${year} - ${String(month + 1).padStart(2, "0")}</h4>
        <div class="cal-nav" id="nextMonth">▶</div>`;
    calPopup.appendChild(header);

    document.getElementById("prevMonth").onclick = () => {
        currentMonth--;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        buildCalendar(currentMonth, currentYear);
    };

    document.getElementById("nextMonth").onclick = () => {
        currentMonth++;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        buildCalendar(currentMonth, currentYear);
    };

    const daysRow = document.createElement("div");
    daysRow.className = "calendar-grid";

    ["D","S","T","Q","Q","S","S"].forEach(d => {
        const div = document.createElement("div");
        div.className = "calendar-day";
        div.textContent = d;
        daysRow.appendChild(div);
    });

    calPopup.appendChild(daysRow);

    const firstDay = new Date(year, month, 1).getDay();
    const totalDays = new Date(year, month + 1, 0).getDate();

    const grid = document.createElement("div");
    grid.className = "calendar-grid";

    for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement("div"));

    for (let d = 1; d <= totalDays; d++) {

        const cell = document.createElement("div");
        cell.className = "calendar-cell";
        cell.textContent = d;

        const cellDate = new Date(year, month, d);

        const isSunday = cellDate.getDay() === 0; // 0 = Domingo

        if (cellDate < today.setHours(0,0,0,0) || isSunday) {
            cell.classList.add("disabled");
        } else {
            cell.addEventListener("click", () => {
                dateInput2.value =
                    `${String(d).padStart(2,"0")}/${String(month+1).padStart(2,"0")}/${year}`;
                calPopup.classList.add("hidden");
                carregarHorasOcupadas();
            });
        }

        grid.appendChild(cell);
    }

    calPopup.appendChild(grid);
}

document.querySelectorAll("#selectDuracao").forEach(select => {
    const selected = select.querySelector(".selected");
    const options = select.querySelectorAll(".custom-options div");

    select.addEventListener("click", e => {
        e.stopPropagation();
        select.classList.toggle("active");
    });

    options.forEach(opt => {
        opt.addEventListener("click", e => {
            e.stopPropagation();
            selected.textContent = opt.textContent;
            selected.dataset.value = opt.dataset.value;
            select.classList.remove("active");
        });
    });
});

/* fechar ao clicar fora */
document.addEventListener("click", () => {
    document
        .querySelectorAll(".custom-select.active")
        .forEach(s => s.classList.remove("active"));
});


/* ============================================================
   SUBMIT — RESERVAR VEÍCULO
============================================================ */
document.getElementById("confirmarReserva")
    ?.addEventListener("click", function () {

        const duracao = Number(
        document.querySelector("#selectDuracao .selected")?.dataset.value
        );


        if (!duracao) {
            return showToast("Seleciona a duração da reserva.");
        }

        fetch("/Reservas/Criar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                idAnuncio: @Model.IdAnuncio,
                horas: duracao
            })
        })
        .then(r => r.json())
        .then(data => {
            showToast(data.msg ?? "Reserva criada.");
            if (data.ok) {
                setTimeout(() => location.reload(), 1200);
            }
        });
    });

    /* ============================================================
   SUBMIT — COMPRAR VEÍCULO
============================================================ */
document.getElementById("confirmarCompra")
    ?.addEventListener("click", function () {

        const metodo = document
            .querySelector("#metodoPagamento .pill-option.active")
            ?.dataset.metodo;

        if (!metodo) {
            return showToast("Seleciona o método de pagamento.");
        }

        fetch("/Compras/Criar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                idAnuncio: @Model.IdAnuncio,
                metodoPagamento: metodo
            })
        })
        .then(r => r.json())
        .then(data => {
            showToast(data.msg ?? "Compra registada.");
            if (data.ok) {
                setTimeout(() => location.reload(), 1200);
            }
        });
    });


</script>
}
