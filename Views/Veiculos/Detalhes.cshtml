@model AutoHubProjeto.Models.Anuncio

@{
    ViewData["Title"] = "Detalhes do Anúncio";

    // texto para o tipo de vendedor
    var textoVendedor = Model.IdVendedorNavigation == null
        ? "Vendedor não definido"
        : (Model.IdVendedorNavigation.Tipo == "empresa"
            ? "Stand / Profissional"
            : "Vendedor particular");

    // imagem principal
    var imagensOrdenadas = Model.AnuncioImagems
        .OrderBy(i => i.Ordem)
        .ToList();

    var urlImagemPrincipal = imagensOrdenadas.Any()
        ? Url.Content("~/" + imagensOrdenadas.First().Url)
        : Url.Content("~/imgs/carros.jpg");
}

@section Styles {
    <link rel="stylesheet" href="~/css/detalhes.css" />
}

<main class="page">
    <div class="container">
        <!-- BREADCRUMB -->
        <div class="breadcrumb">
            <a href="/Anuncios/Index">Anúncios</a> ›
            <span>@Model.Titulo</span>
        </div>

        <div class="details-grid">
            <!-- GALERIA -->
            <section class="soft-card gallery">
                <!-- FOTO PRINCIPAL -->
                <img id="mainPhoto"
                     class="main-photo"
                     src="@urlImagemPrincipal"
                     alt="Foto principal do veículo">

                <!-- MINIATURAS -->
                <div class="thumbs" id="thumbs">
                    @foreach (var img in imagensOrdenadas)
                    {
                        var url = Url.Content("~/" + img.Url);
                        var isActive = img == imagensOrdenadas.First();

                        <img class="@(isActive ? "active" : "")"
                             src="@url"
                             data-photo="@url"
                             alt="Foto @img.Ordem" />
                    }
                </div>
            </section>

            <!-- PAINEL INFO -->
            <aside class="soft-card info">
                <div class="title-row">
                    <h1>@Model.Titulo</h1>

                    <button class="fav @(Model.IsFavorito ? "active" : "") @(User.Identity.IsAuthenticated ? "" : "disabled")"
                             id="favBtn"
                             data-id="@Model.IdAnuncio"
                             data-auth="@User.Identity.IsAuthenticated.ToString().ToLower()">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 21s-6.716-4.297-9.428-7.01A5.988 5.988 0 0 1 12 5a5.988 5.988 0 0 1 9.428 8.99C18.716 16.703 12 21 12 21z" />
                        </svg>
                    </button>



                </div>

                <div class="price">
                    € @Model.Preco.ToString("N0")
                </div>

                <div class="seller">
                    👤 @textoVendedor
                </div>

                <div class="cta-row">
                    <button class="btn requires-auth" data-auth="@User.Identity.IsAuthenticated.ToString().ToLower()">Agendar Visita</button>
                    <button class="btn btn-outline requires-auth" data-auth="@User.Identity.IsAuthenticated.ToString().ToLower()">Reservar</button>
                    <button class="btn btn-outline requires-auth" data-auth="@User.Identity.IsAuthenticated.ToString().ToLower()">Comprar</button>
                </div>

                <div class="soft-card overview">
                    <h3>Especificações</h3>
                    <table class="ov-table">
                        <tr>
                            <td class="ov-left">Ano</td>
                            <td class="ov-right">@Model.IdVeiculoNavigation.Ano</td>
                        </tr>
                        <tr>
                            <td class="ov-left">Marca / Modelo</td>
                            <td class="ov-right">
                                @Model.IdVeiculoNavigation.Marca @Model.IdVeiculoNavigation.Modelo
                            </td>
                        </tr>
                        <tr>
                            <td class="ov-left">Quilometragem</td>
                            <td class="ov-right">
                                @Model.IdVeiculoNavigation.Quilometragem.ToString("N0") km
                            </td>
                        </tr>
                        <tr>
                            <td class="ov-left">Caixa</td>
                            <td class="ov-right">@Model.IdVeiculoNavigation.Caixa</td>
                        </tr>
                        <tr>
                            <td class="ov-left">Combustível</td>
                            <td class="ov-right">@Model.IdVeiculoNavigation.Combustivel</td>
                        </tr>
                        <tr>
                            <td class="ov-left">Localização</td>
                            <td class="ov-right">@Model.IdVeiculoNavigation.Localizacao</td>
                        </tr>
                    </table>
                </div>
            </aside>
        </div>

        <!-- DESCRIÇÃO E EXTRAS -->
        <div class="below">
            <section class="soft-card card-pad">
                <h3>Descrição</h3>
                <p style="color:var(--txt-700);margin-top:8px">
                    @Model.IdVeiculoNavigation.Descricao
                </p>
            </section>

            <aside class="soft-card card-pad">
                <h3>Extras & Destaques</h3>
                <ul class="features" style="margin-top:8px">
                    <li>Ar condicionado automático</li>
                    <li>Bluetooth</li>
                    <li>Bancos em pele</li>
                    <li>Sistema de navegação</li>
                    <li>Computador de bordo</li>
                    <li>Direção assistida</li>
                </ul>
            </aside>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        /* ============================================================
           ALERTA para não autenticados
        ============================================================ */
        function showFavAlert(msg) {
            const div = document.createElement("div");
            div.className = "inline-msg inline-error";
            div.innerText = msg;

            document.body.appendChild(div);

            setTimeout(() => div.style.opacity = "0", 2500);
            setTimeout(() => div.remove(), 3000);
        }

        /* ============================================================
           GALERIA DE IMAGENS
        ============================================================ */
        const main = document.getElementById("mainPhoto");

        if (main) {
            const thumbs = document.querySelectorAll("#thumbs img");

            thumbs.forEach(el => {
                el.addEventListener("click", () => {
                    thumbs.forEach(t => t.classList.remove("active"));
                    el.classList.add("active");
                    main.src = el.dataset.photo;
                });
            });
        }

        /* ============================================================
           FAVORITOS (toggle + proteger não autenticado)
        ============================================================ */

        const fav = document.getElementById("favBtn");

        if (fav) {
            fav.addEventListener("click", function () {

                const isAuth = this.dataset.auth === "true";

                if (!isAuth) {
                    showFavAlert("Precisas de iniciar sessão para favoritar.");
                    return;
                }

                const id = this.dataset.id;

                fetch("/Favoritos/Toggle?idAnuncio=" + id, { method: "POST" })
                    .then(r => r.json())
                    .then(data => {

                        if (!data.ok) {
                            showFavAlert("Ocorreu um erro.");
                            return;
                        }

                        this.classList.toggle("active");

                        // animação
                        this.style.transform = "scale(1.18)";
                        setTimeout(() => this.style.transform = "scale(1)", 150);

                        // atualiza o contador do menu
                        const counter = document.getElementById("favoritosCounter");
                        if (counter && data.total !== undefined) {
                            counter.textContent = data.total;
                        }
                    });


            });
        }

            /* ============================================================
           TOAST premium (para todas as ações bloqueadas)
        ============================================================ */
        function showToast(msg) {
            const box = document.createElement("div");
            box.className = "toast-auth";
            box.innerText = msg;

            document.body.appendChild(box);

            setTimeout(() => box.classList.add("show"), 10);

            setTimeout(() => box.classList.remove("show"), 2200);
            setTimeout(() => box.remove(), 2700);
        }

        /* ============================================================
           BLOQUEAR BOTÕES PARA NÃO AUTENTICADOS
        ============================================================ */
        document.querySelectorAll(".requires-auth").forEach(btn => {
            btn.addEventListener("click", function (e) {
                const auth = this.dataset.auth;

                if (auth !== "true") {
                    e.preventDefault();
                    showToast("Inicia sessão para usar esta funcionalidade.");
                }
            });
        });

    </script>
}

